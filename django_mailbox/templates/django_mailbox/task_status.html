<!DOCTYPE html>
<html>
<head>
    <title>ä»»åŠ¡çŠ¶æ€</title>
    <style>
        .container { max-width: 1000px; margin: 20px auto; }
        .task-item { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .processing { background: #fff3cd; border-left: 4px solid #ffc107; }
        .success { background: #d4edda; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; }
        .stats { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .progress-bar { 
            height: 20px; 
            background: #e9ecef; 
            border-radius: 10px; 
            margin: 10px 0; 
            overflow: hidden; 
        }
        .progress-fill { 
            height: 100%; 
            background: #007bff; 
            transition: width 0.3s; 
        }
        .question-text { 
            white-space: pre-wrap; 
            word-break: break-word; 
            margin: 10px 0; 
        }
        .result-text { 
            white-space: pre-wrap; 
            word-break: break-word; 
            background: white; 
            padding: 10px; 
            border-radius: 3px; 
            margin: 10px 0; 
        }
        .pagination { 
            margin: 20px 0; 
            text-align: center; 
        }
        .pagination a {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-decoration: none;
            color: #007bff;
        }
        .pagination a:hover {
            background: #f0f0f0;
        }
        .pagination .current {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 4px;
            border: 1px solid #007bff;
            border-radius: 4px;
            background: #007bff;
            color: white;
        }
        .pagination-info {
            text-align: center;
            margin: 10px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€</h2>
        
        <div class="stats">
            <h3>æ€»ä½“è¿›åº¦</h3>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ progress_percent }}%;"></div>
            </div>
            <p>å®Œæˆåº¦: {{ progress_percent }}%</p>
            <p>æ€»é—®é¢˜æ•°: {{ total_count }}</p>
            <p>å·²å®Œæˆ: {{ completed_count }}</p>
            <p>å¤„ç†ä¸­: {{ processing_count }}</p>
            <p>å¤±è´¥: {{ error_count }}</p>
            {% if submitted_at %}
            <p>æäº¤æ—¶é—´: {{ submitted_at|date:"Y-m-d H:i:s" }}</p>
            {% endif %}
        </div>

        <!-- åˆ†é¡µä¿¡æ¯ -->
        <!-- åœ¨åˆ†é¡µä¿¡æ¯éƒ¨åˆ†æ·»åŠ  -->
        <div class="pagination-info">
            æ˜¾ç¤º {{ results.start_index }} - {{ results.end_index }} æ¡ï¼Œå…± {{ total_count }} æ¡ä»»åŠ¡
            <form method="get" style="display: inline; margin-left: 20px;">
                <label>æ¯é¡µæ˜¾ç¤ºï¼š
                    <select name="per_page" onchange="this.form.submit()">
                        <option value="1" {% if request.GET.per_page == "1" %}selected{% endif %}>1</option>
                        <option value="2" {% if request.GET.per_page == "3" %}selected{% endif %}>3</option>
                        <option value="10" {% if request.GET.per_page == "10" %}selected{% endif %}>10</option>
                    </select>
                </label>
                {% for key, value in request.GET.items %}
                    {% if key != 'per_page' %}
                        <input type="hidden" name="{{ key }}" value="{{ value }}">
                    {% endif %}
                {% endfor %}
            </form>
        </div>

        {% for result in results %}
        <div class="task-item {% if result.status == 'success' %}success{% elif result.status == 'error' %}error{% else %}processing{% endif %}">
            <h4>é—®é¢˜ {{ forloop.counter0|add:results.start_index }}:</h4>
            <div class="question-text">{{ result.question }}</div>
            
            {% if result.status == 'success' %}
                <p><strong>âœ… ç»“æœ:</strong></p>
                <div class="result-text">{{ result.result }}</div>
            {% elif result.status == 'error' %}
                <p><strong>âŒ é”™è¯¯:</strong> {{ result.error }}</p>
            {% else %}
                <p><strong>â³ çŠ¶æ€:</strong> å¤„ç†ä¸­...ï¼ˆé¢„è®¡10-20åˆ†é’Ÿï¼‰</p>
            {% endif %}
            
            <p><small>ä»»åŠ¡ID: {{ result.task_id }}</small></p>
            {% if result.completed_at %}
            <p><small>å®Œæˆæ—¶é—´: {{ result.completed_at }}</small></p>
            {% endif %}
        </div>
        {% empty %}
        <div class="task-item">
            <p>æš‚æ— ä»»åŠ¡ä¿¡æ¯ï¼Œè¯·å…ˆæäº¤é—®é¢˜</p>
        </div>
        {% endfor %}

        <!-- åˆ†é¡µå¯¼èˆª -->
        {% if results.paginator.num_pages > 1 %}
        <div class="pagination">
            {% if results.has_previous %}
                <a href="?page=1">&laquo; é¦–é¡µ</a>
                <a href="?page={{ results.previous_page_number }}">ä¸Šä¸€é¡µ</a>
            {% endif %}

            {% for num in results.paginator.page_range %}
                {% if results.number == num %}
                    <span class="current">{{ num }}</span>
                {% elif num > results.number|add:'-3' and num < results.number|add:'3' %}
                    <a href="?page={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if results.has_next %}
                <a href="?page={{ results.next_page_number }}">ä¸‹ä¸€é¡µ</a>
                <a href="?page={{ results.paginator.num_pages }}">æœ«é¡µ &raquo;</a>
            {% endif %}
        </div>
        {% endif %}

        <div style="margin-top: 30px; text-align: center;">
            <p>
                <a href="{% url 'django_mailbox:batch_tasks' %}" style="color: #007bff; text-decoration: none; margin-right: 20px;">
                    ğŸ“ è¿”å›æäº¤é¡µé¢
                </a>
                <a href="#" onclick="location.reload()" style="color: #28a745; text-decoration: none;">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </a>
            </p>
        </div>
    </div>
</body>
</html>