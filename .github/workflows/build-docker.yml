# .github/workflows/build-docker.yml
name: 构建 Docker 镜像

# 触发条件：推送到 master 分支或创建 Pull Request 到 master 分支时运行
on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 步骤1：拉取代码仓库
      - name: 检出代码
        uses: actions/checkout@v4

      # 步骤2：设置 Docker Buildx（优化于构建多平台镜像）
      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤3：登录到 Docker Hub（如果需要推送镜像，需在 GitHub Secrets 中配置 DOCKER_HUB_USERNAME 和 DOCKER_HUB_ACCESS_TOKEN）
      - name: 登录到 Docker Hub
        if: github.event_name != 'pull_request'  # PR 时不推送镜像
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

      # 步骤4：构建并推送 web 服务镜像
      - name: 构建并推送 web 镜像
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}  # 仅在推送时上传镜像
          tags: |
            ${{ secrets.DOCKER_HUB_USERNAME }}/djangoproject-web:latest
            ${{ secrets.DOCKER_HUB_USERNAME }}/djangoproject-web:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 步骤5：验证镜像构建结果
      - name: 检查构建的镜像
        run: |
          docker images | grep djangoproject-web